@model AppData.Models.PhieuNhap

@{
    Layout = "~/Views/Shared/_LayoutForAdmin.cshtml";
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
                        <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.slim.min.js"></script>
                        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
                        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
                        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    ViewData["Title"] = "Edit";
}
<h4>Sửa phiếu nhập</h4>
<hr />
<div class="row">
    <div class="col-md-12">
        @if (ViewBag.ErrorMessage != null)
        {
            <div class="alert alert-danger">
                @ViewBag.ErrorMessage
            </div>
        }
        <form asp-action="Edit" id="form">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="ID" />
            <div class="form-group">
                <label asp-for="MaPN" class="control-label">Mã PN</label>
                <input asp-for="MaPN" class="form-control" autocomplete="off" />
                <div id="emptyMaPNError" class="invalid-feedback d-none">Vui lòng nhập mã phiếu nhập!</div>
            </div>
            <div class="form-group">
                <label asp-for="NgayTao" class="control-label">Ngày Tạo</label>
                <input asp-for="NgayTao" class="form-control" autocomplete="off" />
                <div id="emptyNgayTaoError" class="invalid-feedback d-none">Vui lòng chọn ngày tạo !</div>
            </div>
            <div class="form-group">
                <label asp-for="GhiChu" class="control-label">Ghi chú</label>
                <input asp-for="GhiChu" class="form-control" autocomplete="off" />
                <div id="emptyGhiChuError" class="invalid-feedback d-none">Vui lòng nhập vào ghi chú!</div>
            </div>
            <div class="form-group">
                <label asp-for="IDNhanVien" class="control-label">Nhân viên</label>
                <select asp-for="IDNhanVien" class="form-control" asp-items="@ViewBag.DSNhanVien" autocomplete="off">
                    <option value="">-- Chọn --</option>
                </select>
                <div id="emptyIDNhanVienError" class="invalid-feedback d-none">Vui lòng chọn nhân viên!</div>
            </div>
            <div class="form-group">
                <label asp-for="IDKhoHang" class="control-label">Kho Hàng</label>
                <select asp-for="IDKhoHang" class="form-control" asp-items="@ViewBag.DSKhoHang" autocomplete="off">
                    <option value="">-- Chọn --</option>
                </select>
                <div id="emptyIDKhoHangError" class="invalid-feedback d-none">Vui lòng chọn kho hàng!</div>
            </div>
            <div class="form-group">
                <label asp-for="IDNhaCungCap" class="control-label">Nhà Cung Cấp</label>
                <select asp-for="IDNhaCungCap" class="form-control" asp-items="@ViewBag.DSNhaCungCap" autocomplete="off" >
                    <option value="">-- Chọn --</option>
                </select>
                <div id="emptyIDNhaCungCapError" class="invalid-feedback d-none">Vui lòng chọn nhà cung cấp!</div>
            </div>
            <div class="col-12 ml-5">
                <table id="details" class="table table-borderless table-sm mb-0 pb-0">
                    <thead>
                        <tr>
                            <th>Tên sản phẩm</th>
                            <th>Số lượng</th>
                            <th>
                                <button id="btnAddDetailRow" type="button" class="btn btn-sm btn-secondary visible" onclick="AddItem(this)">
                                    Thêm
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.ChiTietPhieuNhaps.Count; i++)
                        {
                            <tr>
                                <td>
                                    <select asp-for="@Model.ChiTietPhieuNhaps[i].IDCTSP" class="form-control" 
                                        asp-items="@ViewBag.DSSanPham">
                                    <option value="">-- Chọn --</option>
                                    </select>
                                    <span asp-validation-for="@Model.ChiTietPhieuNhaps[i].IDCTSP" class="text-danger"></span>
                                </td>
                                <td>
                                    <input asp-for="@Model.ChiTietPhieuNhaps[i].SoLuong" class="form-control" />
                                    <span asp-validation-for="@Model.ChiTietPhieuNhaps[i].SoLuong" class="text-danger"></span>
                                </td>
                                <td>
                                    <button id="btnRemove-@i" type="button" class="btn btn-sm btn-danger visible" onclick="DeleteItem(this)">
                                        Xoá
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="form-group">
                <input type="submit" value="Lưu" class="btn btn-primary" style="margin-top: 10px" />
            </div>
        </form>
    </div>
</div>

<script>
    $("input[name='MaPN']").on("input", function() {
        $(this).removeClass("is-invalid");
        $("#emptyMaPNError").text("");
    });

   

    $("form").submit(function() {

        var tenInput = $("input[name='MaPN']");
        var tenValue = tenInput.val();
        if (tenValue.trim() === "") {
            tenInput.addClass("is-invalid");
            $("#emptyMaPNError").text("Mã phiếu nhập không được bỏ trống");
            return false;
        }

        var nvInput = $("select[name='IDNhanVien'] option:selected");
        var nvValue = nvInput.val();
        if (nvValue.trim() === "") {
            nvInput.addClass("is-invalid");
            $("#emptyIDNhanVienError").text("Vui lòng chọn nhân viên");
            return false;
        }

        var khoInput = $("select[name='IDKhoHang'] option:selected");
        var khoValue = khoInput.val();
        if (khoValue.trim() === "") {
            khoInput.addClass("is-invalid");
            $("#emptyIDKhoHangError").text("Vui lòng chọn kho hàng");
            return false;
        }

        var nccInput = $("select[name='IDNhaCungCap'] option:selected");
        var nccValue = nccInput.val();
        if (nccValue.trim() === "") {
            nccInput.addClass("is-invalid");
            $("#emptyIDNhaCungCapError").text("Vui lòng chọn nhà cung cấp");
            return false;
        }

        return true;
    });
</script>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        function AddItem(btn) {
            var table;
            table = document.getElementById("details");
            var rows = table.getElementsByTagName("tr");
            var rowOuterHtml = rows[rows.length - 1].outerHTML;

            var lastRowIdx = rows.length - 2;

            var nextRowIdx = eval(lastRowIdx) + 1;

            rowOuterHtml = rowOuterHtml.replaceAll('_' + lastRowIdx + "_", "_" + nextRowIdx + "_");
            rowOuterHtml = rowOuterHtml.replaceAll('[' + lastRowIdx + "]", "[" + nextRowIdx + "]");
            rowOuterHtml = rowOuterHtml.replaceAll('-' + lastRowIdx, "-" + nextRowIdx);

            var newRow = table.insertRow();
            newRow.innerHTML = rowOuterHtml;

            var x = document.getElementsByTagName("input");

            for (var cnt = 0; cnt < x.length; cnt++) {
                if (x[cnt].type == "text" && x[cnt].id.indexOf("_" + nextRowIdx + "_") > 0)
                    x[cnt].value = '';
                else if (x[cnt].type == "number" && x[cnt].id.indexOf("_" + nextRowIdx + "_") > 0)
                    x[cnt].value = 0;
            }

            rebindValidators();
        }

        function DeleteItem(btn) {
            var table = document.getElementById("details");
            var rows = table.getElementsByTagName("tr");
            if (rows.length == 2) {
                alert("This row can't be delete");
                return;
            }
            $(btn).closest('tr').remove();
        }

        function rebindValidators() {
            var $form = $("#form");
            $form.unbind();
            $form.data('validator', null);
            $.validator.unobtrusive.parse($form);
            $form.validate($form.data('unobtrusiveValidation').options);
        }
    </script>
}

